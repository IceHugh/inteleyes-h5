<!DOCTYPE html>
<html>

<head lang="en">
  <meta charset="UTF-8">
  <title></title>
  <script type="text/javascript" src="crc32.js"></script>
  <script type="text/javascript" src="js/online.js"></script>

</head>

<body>
  <form id="form1" enctype="multipart/form-data" method="post" action="http://10.25.82.163:8084/uploadFile">
    <input type="file" name="fileToUpload" id="fileToUpload" onchange="fileSelected();" multiple/>

    <div id="ctheader" style="border:1px solid #000; display:none;">
      <input type="button" onclick="uploadFile();" value="Upload" multiple="multiple" />
    </div>
    <!-- 加载进度条 -->
    <progress id="prog" value="0"></progress>
    <!-- 总数量 -->
    <div id="results">0 items</div>



  </form>
  <script>

    var ctheader = document.getElementById("ctheader");
    // 弹窗插件
    function fileSelected() {
      var files = document.getElementById('fileToUpload').files;
      var ctheader = document.getElementById('ctheader');
      for (var i = 0; i < files.length; i++) {
        var file = files[i];
        // if(file.type !=="file") continue;
        var data = new Date().toLocaleString();
        var fileSize = 0;
        if (file.size > 1024 * 1024) {
          fileSize = (Math.round(file.size * 100 / (1024 * 1024)) / 100).toString() + 'MB';
        }
        else {
          fileSize = (Math.round(file.size * 100 / 1024) / 100).toString() + 'KB';
        }

        var div = document.createElement("div")
        // div.innerHTML = "名字："+ file.name +
        // " , 文件类型："+ file.type +" , 文件大小:"+ file.size +" , 时间:"+ data+"<br/>"
        // ctheader.appendChild( div);

        var newElem = document.createElement("table");
        newElem.setAttribute("border", "1");

        addRow(newElem, file.name, file.type, file.size, data);
        ctheader.appendChild(newElem);
        ctheader.style.display = "block";
      }
      sAlert(ctheader.innerHTML);
    }

    // 获取文件信息
    function addRow(elem, name, filetype, fileSize, dataTime) {
      elem.innerHTML += "<tr><td>" + name + "</td><td>" + filetype + "</td><td>" + fileSize + "KB</td><td>" + dataTime + "</td></tr>"
    }


    function uploadFile() {
      //定义表单变量    
      var files = document.getElementById('fileToUpload').files;
      var progress = document.getElementById('prog');

      //新建一个FormData对象    
      var formData = new FormData();
      var fileSign = {};
      for (var i = 0, j = 0; i < files.length; i++) {
        // debugger
        var file = files[i]
        var reader = new FileReader();
        reader.readAsArrayBuffer(file);
        (function (file) {
          reader.onload = function (e) {
            var res = getBinary(e.target.result);
            // debugger;
            var cres = crc32.table(res);
            console.log(cres);
            fileSign[file.name] = cres;
            res = new Base64().encode(res);
            formData.append("data", new Blob([res], { type: 'application/octet-stream' }), file.name);
            if (j === files.length - 1) {
              var fileinfo = {
                institutionId: "00001",
                channelId: "00002",
                serialUID: "0000001.0001",
                fileSign: fileSign
              }
              formData.append('fileinfo', new Blob([JSON.stringify(fileinfo)], { type: 'application/json' }, 'fileinfo'));
              sendData(formData);
            }
            j++;
          }
        })(file);
      }

      function sendData(formData) {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "http://10.25.82.163:8084/uploadFile");
        xhr.send(formData);
        xhr.addEventListener('readystatechange', function handleResponse(e) {
          if (xhr.readyState == 4 && xhr.status == 200) {
            document.getElementById("results").innerHTML = xhr.responseText;
          }
        });
        var upload = xhr.upload;
        upload.addEventListener('progress', function (e) {
          // progress.max = e.total;
          // progress.value=e.loaded;
          if (e.lengthComputable) { progress.value = Math.round(100 * e.loaded / e.total) + "%" }
        });
        upload.addEventListener('load', function (e) {
          progress.max = 1;
          progress.value = 1;
        });
        // xhr.send(JSON.stringify(formData));
      }
    }
    function getBinary(res) {
      var binary = "";
      var bytes = new Uint8Array(res);

      var length = bytes.byteLength;

      for (var i = 0; i < length; i++) {

        binary += String.fromCharCode(bytes[i]);

      }
      return binary;
    }
    function Base64() {

      // private property
      _keyStr = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";

      // public method for encoding
      this.encode = function (input) {
        var output = "";
        var chr1, chr2, chr3, enc1, enc2, enc3, enc4;
        var i = 0;
        input = _utf8_encode(input);
        while (i < input.length) {
          chr1 = input.charCodeAt(i++);
          chr2 = input.charCodeAt(i++);
          chr3 = input.charCodeAt(i++);
          enc1 = chr1 >> 2;
          enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
          enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
          enc4 = chr3 & 63;
          if (isNaN(chr2)) {
            enc3 = enc4 = 64;
          } else if (isNaN(chr3)) {
            enc4 = 64;
          }
          output = output +
            _keyStr.charAt(enc1) + _keyStr.charAt(enc2) +
            _keyStr.charAt(enc3) + _keyStr.charAt(enc4);
        }
        return output;
      }
 
    // private method for UTF-8 encoding
    _utf8_encode = function (string) {
        string = string.replace(/\r\n/g,"\n");
        var utftext = "";
        for (var n = 0; n < string.length; n++) {
            var c = string.charCodeAt(n);
            if (c < 128) {
                utftext += String.fromCharCode(c);
            } else if((c > 127) && (c < 2048)) {
                utftext += String.fromCharCode((c >> 6) | 192);
                utftext += String.fromCharCode((c & 63) | 128);
            } else {
                utftext += String.fromCharCode((c >> 12) | 224);
                utftext += String.fromCharCode(((c >> 6) & 63) | 128);
                utftext += String.fromCharCode((c & 63) | 128);
            }
 
        }
        return utftext;
    }
    }
  </script>
</body>

</html>